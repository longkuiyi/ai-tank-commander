# 🎮 游戏测试指南

## 🚀 服务器已启动

**访问地址：** http://localhost:3002/

---

## 🧪 测试重点

### 1. 核心功能测试

#### ✅ AI 战术建议
**测试内容：**
- 开始游戏后，观察右上角的"战术分析"面板
- 应该显示详细的战术分析，包括：
  - 态势总览（兵力对比、基地状态）
  - 判断依据
  - 执行要点（分点列出）
  - 军需建议

**预期效果：**
```
主令：全军突击
态势：我方存活 5 vs 敌方 5｜我方基地受压 0%｜敌方核心推进 0%｜金币 0
判断：我方兵力略占优，适合把战线前推：先压制火力点，再分队切入核心。
要点：
- 兵力对比 5:5：用两翼包抄压缩火力扇区。
- 执行要点：先秒指挥官/低血目标，再滚雪球推进。
```

#### ✅ AI 模型显示
**测试内容：**
- 查看战术分析面板底部
- 应该显示当前使用的 AI 模型和响应时间

**预期效果：**
```
模型: 🧠 Ollama        1234ms
或
模型: ✨ Gemini        2345ms
或
模型: ⚙️ 规则引擎      50ms
```

#### ✅ 规则引擎智能
**测试场景：**

1. **基地危急（进度 > 60%）**
   - 预期：AI 发出紧急回防指令
   - 对话："基地告急！我正在全速回援！"

2. **即将胜利（敌方进度 > 70%）**
   - 预期：AI 发出加速占领指令
   - 对话："敌方即将崩溃，加速占领！"

3. **兵力优势**
   - 预期：AI 发起总攻
   - 对话："火力全开，准备冲击敌方防线！"

4. **兵力劣势**
   - 预期：AI 采取侦察战术
   - 分析："敌方兵力占优，采取分散侦察战术，寻找突破口。"

---

### 2. 容错性测试

#### ✅ localStorage 容量保护
**测试步骤：**
1. 打开浏览器控制台
2. 输入：`localStorage.getItem('ai_tank_commander_kb')`
3. 查看数据大小

**预期效果：**
- 数据不会超过 5MB
- 自动清理旧数据
- 不会因为配额满而崩溃

#### ✅ API 失败降级
**测试场景：**
1. 关闭 Ollama 服务
2. 不配置 Gemini API Key
3. 游戏应该自动使用规则引擎

**预期效果：**
- 控制台显示：`[AI-WARN] 使用规则引擎降级方案`
- 游戏正常运行
- AI 建议依然详细

---

### 3. 新功能测试

#### ✅ 命令规范化
**测试方法：**
- 如果 AI 返回中文命令（如"全军突击"），应该自动转换为 `ATTACK`
- 如果 AI 返回 `FREE`，应该自动转换为 `FREE_PLANNING`

#### ✅ JSON 解析增强
**测试场景：**
AI 可能返回以下格式，都应该能正确解析：

```json
// 格式1：标准 JSON
{"command": "ATTACK", "globalAnalysis": "..."}

// 格式2：Markdown code block
```json
{"command": "ATTACK", "globalAnalysis": "..."}
```

// 格式3：带尾逗号（错误格式）
{"command": "ATTACK", "globalAnalysis": "...",}

// 格式4：带注释（错误格式）
{
  "command": "ATTACK", // 主命令
  "globalAnalysis": "..."
}
```

**预期效果：**
- 所有格式都能正确解析
- 控制台不会报错

---

### 4. 性能测试

#### ✅ 响应时间
**观察指标：**
- Ollama：通常 < 2000ms
- Gemini：通常 < 3000ms
- 规则引擎：通常 < 100ms

#### ✅ 速率限制
**测试方法：**
1. 快速切换战术指令（按 1-6 键）
2. 观察控制台

**预期效果：**
- 如果调用过快，会看到：`[AI-WARN] API 调用频率限制，等待 X 秒`
- 不会因为频繁调用而被 API 封禁

---

### 5. 错误处理测试

#### ✅ Error Boundary
**测试方法：**
1. 在浏览器控制台输入：
   ```javascript
   throw new Error('测试错误')
   ```

**预期效果：**
- 显示美观的错误页面
- 提供"重新加载游戏"按钮
- 开发环境显示详细错误信息

---

## 🎯 关键测试点

### 必测项目 ✅

1. **战术分析详细度**
   - [ ] 显示态势总览
   - [ ] 显示判断依据
   - [ ] 显示执行要点（分点）
   - [ ] 显示军需建议

2. **AI 模型切换**
   - [ ] Ollama 可用时使用 Ollama
   - [ ] Ollama 不可用时使用 Gemini
   - [ ] 都不可用时使用规则引擎
   - [ ] 显示当前使用的模型

3. **规则引擎智能**
   - [ ] 基地危急时紧急回防
   - [ ] 即将胜利时加速占领
   - [ ] 兵力优势时发起总攻
   - [ ] 兵力劣势时侦察战术

4. **容错性**
   - [ ] localStorage 不会溢出
   - [ ] API 失败自动降级
   - [ ] JSON 解析容错
   - [ ] 命令规范化

---

## 🐛 已知问题

### ErrorBoundary.tsx
- **问题：** React 19 类型定义问题
- **影响：** TypeScript 报错，但功能完全正常
- **状态：** 可以忽略

---

## 📊 测试结果记录

### 功能测试
- [ ] 战术分析显示正常
- [ ] AI 模型显示正常
- [ ] 规则引擎智能正常
- [ ] 对话质量提升

### 容错测试
- [ ] localStorage 保护正常
- [ ] API 降级正常
- [ ] JSON 解析容错正常
- [ ] 命令规范化正常

### 性能测试
- [ ] 响应时间正常
- [ ] 速率限制正常
- [ ] 无内存泄漏

### 错误处理
- [ ] Error Boundary 正常
- [ ] 日志输出清晰

---

## 🎮 开始测试

1. **打开浏览器**
   - 访问：http://localhost:3002/

2. **打开控制台**
   - Chrome/Edge: F12
   - Mac: Cmd + Option + I

3. **开始游戏**
   - 设置队友和敌人数量
   - 点击"部署作战系统"

4. **观察 AI 建议**
   - 查看右上角战术分析面板
   - 查看左上角战术指挥链路
   - 查看控制台日志

5. **测试不同场景**
   - 让基地被占领（测试紧急回防）
   - 占领敌方基地（测试加速占领）
   - 击杀敌人（测试兵力优势）

---

## 💡 调试技巧

### 查看 AI 日志
```javascript
// 在控制台输入
localStorage.getItem('ai_tank_commander_kb')
```

### 清空知识库
```javascript
// 在控制台输入
localStorage.removeItem('ai_tank_commander_kb')
```

### 查看存储使用情况
```javascript
// 在控制台输入
const kb = localStorage.getItem('ai_tank_commander_kb');
console.log(`存储大小: ${kb ? kb.length : 0} 字节`);
console.log(`存储占比: ${kb ? Math.round((kb.length / (5 * 1024 * 1024)) * 100) : 0}%`);
```

---

## 🎉 预期体验

### 改进前
```
战术分析: "我方战力充沛，发起总攻。"
```

### 改进后
```
主令：全军突击
态势：我方存活 5 vs 敌方 4｜我方基地受压 0%｜敌方核心推进 15%｜金币 50
判断：我方兵力略占优，适合把战线前推：先压制火力点，再分队切入核心。
要点：
- 兵力对比 5:4：用两翼包抄压缩火力扇区。
- 执行要点：先秒指挥官/低血目标，再滚雪球推进。
军需建议：永久伤害（若金币足够）

模型: ⚙️ 规则引擎      45ms
```

**差异：**
- ✅ 更详细的态势分析
- ✅ 更专业的战术建议
- ✅ 更清晰的执行要点
- ✅ 显示 AI 模型和响应时间

---

## 🚀 开始测试吧！

游戏已经在 http://localhost:3002/ 运行，打开浏览器开始体验吧！

祝你游戏愉快！🎮
